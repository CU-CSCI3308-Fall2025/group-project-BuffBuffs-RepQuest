{{!-- Loop over each set of nodes --}}
{{!-- <div class="wrapper">

  <div class="pagecontent">
    {{#each sets}}
      <div class="background">
        <div class="work-color"></div>
        <div class="work-color"></div>
        <div class="work-color"></div>
      </div>
      {{> nodes nodes=this }}
    {{/each}}
  </div>
</div> --}}
{{#each sets}}
  <section class="path-section">
    <div class="home-background">
      <div class="work-color"></div>
      <div class="work-color"></div>
      <div class="work-color"></div>
    </div>

    <div class="pagecontent">
      <h1 class="week-header page-title text-center mb-4">Week {{inc @index}}</h1>
      {{> nodes nodes=this }}
    </div>
  </section>
{{/each}}

<div id="workoutModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <p>Log this workout?</p>
    {{!-- <button id="confirmBtn" class="modal-skip">Yes</button>
    <button id="cancelBtn">No</button> --}}
    <button id="confirmBtn" class="modal-btn onboarding-next">Yes</button>
    <button id="cancelBtn" class="modal-btn onboarding-prev">No</button>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const nodes = document.querySelectorAll('.node');
    const modal = document.getElementById('workoutModal');
    const closeBtn = modal.querySelector('.close');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = modal.querySelector('#cancelBtn');

    let currentNode = null;
    let highestCompleted = 0;

    try {
      const res = await fetch('/api/progress');
      if (!res.ok) {
        console.warn('Progress fetch failed with status', res.status);
        if (res.status === 401) {
          window.location.href = '/login';
        }
      } else {
        const data = await res.json();
        console.log('Loaded progress from server:', data);
        highestCompleted = Number(data.highest_completed) || 0;
      }
    } catch (err) {
      console.error('Failed to load progress', err);
    }

    nodes.forEach(node => {
      const id = parseInt(node.dataset.id);
      const type = node.dataset.type;   

      if (id <= highestCompleted) {
        if (type === "rest") {
          node.src = "/img/pathlevel-greenRest.png";
        } else if (type === "push"){
          node.src = "/img/pathlevel-greenPush.png";
        } else if (type === "pull"){
          node.src = "/img/pathlevel-greenPull.png";
        } else if (type === "legs"){
          node.src = "/img/pathlevel-greenLegs.png";
        } else {
          node.src = "/img/pathlevel-green.png";
        }
        node.classList.add('unlocked');
      } else if (id === highestCompleted + 1) {
        node.classList.add('unlocked');
      }
    });

    nodes.forEach(node => {
      node.addEventListener('click', () => {
        if (!node.classList.contains('unlocked')) return;
        currentNode = node;
        modal.style.display = 'flex';
      });
    });

    closeBtn.addEventListener('click', () => modal.style.display = 'none');
    cancelBtn.addEventListener('click', () => modal.style.display = 'none');

    confirmBtn.addEventListener('click', async () => {
      if (!currentNode) return;

      const completedId = parseInt(currentNode.dataset.id);

      const type = currentNode.dataset.type;
      if (type === "rest") {
        currentNode.src = "/img/pathlevel-greenRest.png";
      }    else if (type === "push"){
        currentNode.src = "/img/pathlevel-greenPush.png";
      }    else if (type === "pull"){
        currentNode.src = "/img/pathlevel-greenPull.png";
      }    else if (type === "legs"){
        currentNode.src = "/img/pathlevel-greenLegs.png";
      }else {
        currentNode.src = "/img/pathlevel-green.png";
      }
      try {
        await fetch('/api/workouts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ workoutId: completedId })
        });

        await fetch('/api/progress', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ completed: completedId })
        });

        highestCompleted = Math.max(highestCompleted, completedId);

        const nextNode = document.querySelector(`.node[data-id="${completedId + 1}"]`);
        if (nextNode) nextNode.classList.add('unlocked');
      } catch (err) {
        console.error('Failed to save workout/progress', err);
      }

      modal.style.display = 'none';
    });

    window.addEventListener('click', (e) => {
      if (e.target === modal) modal.style.display = 'none';
    });
  });
</script>