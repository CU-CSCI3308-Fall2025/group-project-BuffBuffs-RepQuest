<link rel="stylesheet" href="/css/styles.css">

<div class="vertical-pathway">
  <div class="step" style="--offset: -10%;">
    <img src="/img/pathlevel-gray.PNG" class="node" data-id="1" alt="Workout 1">
  </div>

  <div class="step" style="--offset: 10%;">
    <img src="/img/pathlevel-gray.PNG" class="node" data-id="2" alt="Workout 2">
  </div>

  <div class="step" style="--offset: -10%;">
    <img src="/img/pathlevel-gray.PNG" class="node" data-id="3" alt="Workout 3">
  </div>

  <div class="step" style="--offset: 10%;">
    <img src="/img/pathlevel-gray.PNG" class="node" data-id="4" alt="Workout 4">
  </div>

  <div class="step" style="--offset: -10%;">
    <img src="/img/pathlevel-gray.PNG" class="node" data-id="5" alt="Workout 5">
  </div>

  <div class="step" style="--offset: 10%;">
    <img src="/img/pathlevel-gray.PNG" class="node" data-id="6" alt="Workout 6">
  </div>

  <div class="step" style="--offset: -10%;">
    <img src="/img/pathlevel-gray.PNG" class="node" data-id="7" alt="Workout 7">
  </div>
</div>

<!-- Modal for logging workouts -->
<div id="workoutModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <p>Log this workout?</p>
    <button id="confirmBtn">Yes</button>
    <button id="cancelBtn">No</button>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const nodes = document.querySelectorAll('.node');
    const modal = document.getElementById('workoutModal');
    const closeBtn = modal.querySelector('.close');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = modal.querySelector('#cancelBtn');

    let currentNode = null;
    let highestCompleted = 0;

    // Load progress from server
    try {
      const res = await fetch('/api/progress');
      if (!res.ok) {
        console.warn('Progress fetch failed with status', res.status);
        if (res.status === 401) {
          // Not logged in; go to login page
          window.location.href = '/login';
        }
      } else {
        const data = await res.json();
        console.log('Loaded progress from server:', data);
        highestCompleted = Number(data.highest_completed) || 0;
      }
    } catch (err) {
      console.error('Failed to load progress', err);
    }


    // Apply saved progress visually
    nodes.forEach(node => {
      const id = parseInt(node.dataset.id);

      if (id <= highestCompleted) {
        node.src = "/img/pathlevel-green.PNG";
        node.classList.add('unlocked');
      } else if (id === highestCompleted + 1) {
        node.classList.add('unlocked');
      }
    });

    // Node click
    nodes.forEach(node => {
      node.addEventListener('click', () => {
        if (!node.classList.contains('unlocked')) return;
        currentNode = node;
        modal.style.display = 'flex';
      });
    });

    closeBtn.addEventListener('click', () => modal.style.display = 'none');
    cancelBtn.addEventListener('click', () => modal.style.display = 'none');

    // Confirm button: record workout + update progress
    confirmBtn.addEventListener('click', async () => {
      if (!currentNode) return;

      const completedId = parseInt(currentNode.dataset.id);

      // Optimistically update UI
      currentNode.src = "/img/pathlevel-green.PNG";

      try {
        // 1) Record the workout in the workouts table (per user)
        await fetch('/api/workouts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ workoutId: completedId })
        });

        // 2) Update highest_completed in user_progress
        await fetch('/api/progress', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ completed: completedId })
        });

        // Update highestCompleted in JS
        highestCompleted = Math.max(highestCompleted, completedId);

        // Unlock next node if it exists
        const nextNode = document.querySelector(`.node[data-id="${completedId + 1}"]`);
        if (nextNode) nextNode.classList.add('unlocked');
      } catch (err) {
        console.error('Failed to save workout/progress', err);
      }

      modal.style.display = 'none';
    });

    window.addEventListener('click', (e) => {
      if (e.target === modal) modal.style.display = 'none';
    });
  });
</script>